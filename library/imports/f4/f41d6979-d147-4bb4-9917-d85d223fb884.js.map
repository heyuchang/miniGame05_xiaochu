{"version":3,"sources":["assets\\Script\\Moudle\\View\\GameInfoView.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import CacheMgr from \"../../Common/manage/CacheMgr\";\r\nimport LayerPanel, {UrlInfo} from \"../../Common/manage/Layer/LayerPanel\";\r\nimport Global from \"../../Common/Global\";\r\nimport ShortageView from \"./ShortageView\";\r\nimport PanelMgr, {Layer} from \"../../Common/manage/PanelMgr\";\r\nimport property = cc._decorator.property;\r\nimport Tools from \"../../Common/Tools\";\r\nimport tween = cc.tween;\r\n\r\nconst {ccclass} = cc._decorator;\r\n\r\n@ccclass\r\nexport default class GameInfoView extends LayerPanel {\r\n\r\n    public static getUrl(): UrlInfo {\r\n        return {\r\n            bundle: \"gameInfoView\",\r\n            name: \"gameInfoView\"\r\n        }\r\n    }\r\n\r\n    @property(cc.Prefab)\r\n    private fly_gold: cc.Prefab = null //执行飞金币动画的图片\r\n    @property(cc.Integer)\r\n    private boomTime: number = 0.5 //金币爆开时长\r\n    @property(cc.Integer)\r\n    private flyTime: number = 1  //金币飞行时间\r\n    @property(cc.Integer)\r\n    private radius_min: number = 50 //最小半径\r\n    @property(cc.Integer)\r\n    private radius_max: number = 100 //最大半径\r\n    @property(cc.Integer)\r\n    private fly_gold_min: number = 4\r\n    @property(cc.Integer)\r\n    private fly_gold_max: number = 10\r\n    @property(cc.Integer)\r\n    private gold_scale_min: number = 0.9\r\n    @property(cc.Integer)\r\n    private gold_scale_max: number = 1.2\r\n\r\n    private goldPool: cc.NodePool = new cc.NodePool() //\r\n\r\n    private fly_end: cc.Vec3 = null\r\n\r\n    private gold: cc.Node = null;\r\n    private diamond: cc.Node = null;\r\n\r\n    private gold_add_button: cc.Node = null;\r\n\r\n    private animationTime: number = null;\r\n    private gold_num: number = null;\r\n    private diamond_num: number = 0;\r\n    private timeouts: Map<string, number[]> = new Map<string, number[]>();\r\n\r\n    private static gameInfoViewIns: GameInfoView = null;\r\n\r\n    public static INS(): GameInfoView {\r\n        return this.gameInfoViewIns;\r\n    }\r\n\r\n    initUI(): void {\r\n        GameInfoView.gameInfoViewIns = this;\r\n        this.gold_num = CacheMgr.gold;\r\n        this.diamond_num = CacheMgr.diamond;\r\n        this.animationTime = Global.config.gameInfo.animation;\r\n        this.gold = this.getNode(\"gold/num\");\r\n        this.gold_add_button = this.getNode(\"gold/add\");\r\n\r\n        this.timeouts.set(\"gold\", []);\r\n        this.timeouts.set(\"diamond\", []);\r\n\r\n        let gold = this.getNode(\"gold\")\r\n        let gold_icon = this.getNode(\"gold/icon\")\r\n\r\n        this.initPool()\r\n        this.scheduleOnce(() => {\r\n            let wp = gold.convertToWorldSpaceAR(gold_icon.position)\r\n            this.fly_end = this.node.convertToNodeSpaceAR(wp)\r\n        }, 0)\r\n    }\r\n\r\n    show(param: any): void {\r\n        this.gold.getComponent(cc.Label).string = this.gold_num.toString();\r\n\r\n        this.onTouch(this.gold_add_button, () => {\r\n            PanelMgr.INS.openPanel({\r\n                panel: ShortageView,\r\n                layer: Layer.gameLayer,\r\n                param: {\r\n                    type: \"gold\",\r\n                }\r\n            })\r\n        });\r\n\r\n    }\r\n\r\n    hide() {\r\n\r\n    }\r\n\r\n    //初始化节点池\r\n    private initPool() {\r\n        if (this.fly_gold) {\r\n            for (let i = 0; i < this.fly_gold_max; i++) {\r\n                let gold = cc.instantiate(this.fly_gold)\r\n                this.goldPool.put(gold)\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 监听金币是否改变\r\n     * @param dt\r\n     * @protected\r\n     */\r\n    protected update(dt: number) {\r\n        let newGold = CacheMgr.gold;\r\n        if (this.gold_num != newGold) {\r\n            this.changeAnimation(\"gold\", newGold - this.gold_num);\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * 修改金币动画\r\n     * @param type\r\n     * @param num\r\n     * @private\r\n     */\r\n    private changeAnimation(type: string, num: number) {\r\n        this.clearTimeOut(type);\r\n        let num_bas = Math.abs(num);\r\n        let time = this.animationTime / num_bas;\r\n        let allTime = 0;   //累计耗时间\r\n        let num_ = this[type + \"_num\"];\r\n        this[type + \"_num\"] += num;\r\n        for (let i = 1; i <= num_bas; i++) {\r\n            if (num < 0) {\r\n                let arr = this.timeouts.get(type);\r\n                arr[i] = window.setTimeout(() => {\r\n                    this[type].getComponent(cc.Label).string = (num_ - i).toString();\r\n                }, allTime * 1000);\r\n                allTime += time;\r\n            } else {\r\n                let arr = this.timeouts.get(type);\r\n                arr[i] = window.setTimeout(() => {\r\n                    this[type].getComponent(cc.Label).string = (num_ + i).toString();\r\n                }, allTime * 1000);\r\n                allTime += time;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 清空所有动画\r\n     * @param type\r\n     * @private\r\n     */\r\n    private clearTimeOut(type: string) {\r\n        //停止所有关于 该类型改变的值\r\n        let timeouts = this.timeouts.get(type);\r\n        for (let i = 0; i < timeouts.length; i++) {\r\n            if (this.timeouts[i]) {\r\n                window.clearTimeout(timeouts[i]);\r\n            }\r\n        }\r\n        this[type].getComponent(cc.Label).string = this[type + \"_num\"].toString();   //直接赋值\r\n        this.timeouts.set(type, []);\r\n    }\r\n\r\n    /**\r\n     * @param point 需要飞金币的起始点（世界坐标）\r\n     * @private\r\n     */\r\n    public fly_gold_animation(pointPosition: cc.Vec3) {\r\n        pointPosition = this.node.convertToNodeSpaceAR(pointPosition)\r\n        return new Promise((resolve, reject) => {\r\n            let num = Tools.getRandom(this.fly_gold_min, this.fly_gold_max - 1)\r\n            if (num > this.goldPool.size()) {\r\n                resolve(true)\r\n                return\r\n            }\r\n            let p: any [] = []\r\n            for (let i = 0; i < num; i++) {\r\n                let pro = new Promise((resolve, reject) => {\r\n                    let gold = this.goldPool.get()\r\n                    gold.position = cc.v3(pointPosition)\r\n                    this.node.addChild(gold)\r\n                    let scale = Tools.getRealRandom(this.gold_scale_min, this.gold_scale_max)\r\n                    gold.scale = scale\r\n                    //随机角度， 随机半径\r\n                    let angle = Tools.getRandom(0, 360)\r\n                    let r = Tools.getRandom(this.radius_min, this.radius_max + 1)\r\n                    let boomPoint = Tools.getCirclePoint(pointPosition, r, angle)\r\n                    tween(gold)\r\n                        .to(this.boomTime, {position: boomPoint}, {easing: \"quadOut\"})\r\n                        .to(this.flyTime, {position: this.fly_end}, {easing: \"quadOut\"})\r\n                        .call(() => {\r\n                            this.goldPool.put(gold)\r\n                            resolve(true)\r\n                        })\r\n                        .start()\r\n                })\r\n                p.push(pro)\r\n            }\r\n            Promise.all(p).then(() => {\r\n                resolve(true)\r\n            })\r\n        })\r\n    }\r\n\r\n}\r\n"]}